<!DOCTYPE html>
<html lang="en" class="light-style layout-navbar-fixed layout-menu-fixed layout-compact" dir="ltr"
    data-theme="theme-default" data-assets-path="/assets/" data-template="vertical-menu-template" data-style="light">

<head>
    <%- include('../layout/head') %>
</head>
<style>
    .offcanvas-backdrop {
        opacity: 0.5 !important;
    }

    .table {
        padding: 3px;
    }
</style>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <!-- Menu -->
            <%- include('../layout/aside') %>
                <!-- / Menu -->

                <!-- Layout container -->
                <div class="layout-page">
                    <!-- Navbar -->
                    <%- include('../layout/side') %>
                        <!-- / Navbar -->

                        <!-- Content wrapper -->
                        <div class="content-wrapper">
                            <!-- Content -->
                            <div class="container-xxl flex-grow-1 container-p-y">
                                <!-- DataTable with Buttons -->

                                <form method="GET" action="" class="p-4">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="taxpayer_name" class="form-label">Taxpayer Name</label>
                                                <input type="text" id="taxpayer_name" name="taxpayer_name"
                                                    class="form-control" value="" />
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="tax_payer_type" class="form-label">Taxpayer Type</label>
                                                <select id="tax_payer_type" name="tax_payer_type" class="form-control"
                                                    required>
                                                    <option value="" disabled selected>Select Taxpayer Type</option>
                                                    <option value="Individual">Individual</option>
                                                    <option value="Company">Company</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="mobile_number" class="form-label">Mobile Number</label>
                                                <input type="text" id="mobile_number" name="mobile_number"
                                                    class="form-control" value="" />
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="taxpayer_tin" class="form-label">Taxpayer TIN</label>
                                                <input type="text" id="taxpayer_tin" name="taxpayer_tin"
                                                    class="form-control" value="" />
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="email_addresss" class="form-label">Email Address</label>
                                                <input type="email" id="email_addresss" name="email_addresss"
                                                    class="form-control" value="" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">Search</button>
                                    </div>
                                </form>
                                <div class="card">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-6"></div>
                                            <div class="col-6" style="text-align: end">
                                                <button class="create-new btn btn-primary waves-effect waves-light"
                                                    data-bs-toggle="offcanvas" data-bs-target="#add-new-record">
                                                    <i class="ti ti-plus me-sm-1"></i>
                                                    <span class="d-none d-sm-inline-block">Add New Tax Payer</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Add TaxPayers List -->
                                    <div class="card-datatable table-responsive pt-0">
                                        <table class="table" id="taxPayerTable">
                                            <thead>
                                                <tr>
                                                    <th>Action</th>
                                                    <th>Name</th>
                                                    <th>TIN</th>
                                                    <th>Mobile Number</th>
                                                    <th>Email</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% results.forEach((taxPayer, index)=> { %>
                                                    <tr>
                                                        <td>
                                                            <div class="dropdown">
                                                                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                                                  <i class="ti ti-dots-vertical"></i>
                                                                </button>
                                                                <div class="dropdown-menu">
                                                                  <a class="dropdown-item"
                                                                  
                                                                   >
                                                                    <i class="ti ti-eye me-1"></i>View Taxpayer
                                                                  </a>

                                                                  <a class="dropdown-item"  
                                                                  href="javascript:;"
                                                                  data-tin="<%= taxPayer.taxpayer_tin %>"
                                                                  data-name="<%= taxPayer.taxpayer_name %>"
                                                                  id="generate_tcc">
                                                                    <i class="ti ti-folder  me-1"></i>Generate TCC
                                                                  </a>
                                                                  <a class="dropdown-item" href="javascript:void(0);" >
                                                                    <i class="ti ti-trash me-1"></i>Delete
                                                                  </a>
                                                                </div>
                                                              </div>
                                                        </td>
                                                        <td>
                                                            <%= taxPayer.taxpayer_name %>
                                                        </td>
                                                        <td>
                                                            <%= taxPayer.taxpayer_tin %>
                                                        </td>
                                                        <td>
                                                            <%= taxPayer.mobile_number %>
                                                        </td>
                                                        <td>
                                                            <%= taxPayer.contactaddress %>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>

                                </div>

                                <!-- Offcanvas to add/edit record -->
                                <div class="offcanvas offcanvas-end" id="add-new-record">
                                    <div class="offcanvas-header border-bottom">
                                        <h5 class="offcanvas-title" id="offcanvasLabel">
                                            Add New Record
                                        </h5>
                                        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="offcanvas-body flex-grow-1">
                                        <form class="add-new-record pt-0 row g-2" id="form-add-new-record"
                                            onsubmit="return false">
                                            <div class="col-12">
                                                <label class="form-label" for="taxpayer_name">Taxpayer Name</label>
                                                <input type="text" id="taxpayer_name" name="taxpayer_name"
                                                    class="form-control" placeholder="Enter Taxpayer Name" required />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="taxpayer_tin">Taxpayer TIN</label>
                                                <input type="text" id="taxpayer_tin" name="taxpayer_tin"
                                                    class="form-control" placeholder="Enter Taxpayer TIN" required />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="mobile_number">Mobile Number</label>
                                                <input type="text" id="mobile_number" name="mobile_number"
                                                    class="form-control" placeholder="Enter Mobile Number" required />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="email_addresss">Email Address</label>
                                                <input type="email" id="email_addresss" name="email_addresss"
                                                    class="form-control" placeholder="Enter Email Address" required />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="tax_payer_type">Taxpayer Type</label>
                                                <select id="tax_payer_type" name="tax_payer_type" class="form-control"
                                                    required>
                                                    <option value="" disabled selected>Select Taxpayer Type</option>
                                                    <option value="Individual">Individual</option>
                                                    <option value="Company">Company</option>
                                                </select>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="contactaddress">Contact Address</label>
                                                <input type="text" id="contactaddress" name="contactaddress"
                                                    class="form-control" placeholder="Enter Contact Address" required />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="bvn">BVN</label>
                                                <input type="text" id="bvn" name="bvn" class="form-control"
                                                    placeholder="Enter BVN" />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label" for="nin">NIN</label>
                                                <input type="text" id="nin" name="nin" class="form-control"
                                                    placeholder="Enter NIN" />
                                            </div>
                                            <!-- <div class="col-12">
                                                <label class="form-label" for="photo_url">Image</label>
                                                <input type="file" id="photo_url" name="photo_url"
                                                    class="form-control" />
                                            </div> -->
                                            <div class="col-sm-12">
                                                <button type="submit" id="submit-btn"
                                                    class="btn btn-primary me-sm-4 me-1">
                                                    <span class="spinner-border d-none" id="loading-spinner"
                                                        role="status" aria-hidden="true"></span>
                                                    &nbsp;Submit
                                                </button>
                                                <button type="reset" class="btn btn-outline-secondary"
                                                    data-bs-dismiss="offcanvas">
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- Toast Container -->
                                <div class="toast-container position-fixed top-0 end-0 p-3">
                                    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                                        <div class="toast-header">
                                            <strong class="me-auto">Notification</strong>
                                            <button type="button" class="btn-close" data-bs-dismiss="toast"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="toast-body" id="toast-message"></div>
                                    </div>
                                </div>
                            </div>

                            <%- include('../layout/footer') %>
                        </div>
                </div>
        </div>
    </div>

    <!-- Add New Credit Card Modal -->
    <div class="modal fade" id="addNewCCModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered1 modal-simple modal-add-new-cc">
          <div class="modal-content">
            <div class="modal-body">
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              <div class="text-center mb-6">
                <h4 class="mb-2">TCC Generation</h4>
                <!-- <p>Add new card to complete payment</p> -->
              </div>
              <form id="addNewCCForm" class="row g-6" onsubmit="return false">
                
                <div class="col-12">
                  <label class="form-label" for="modalAddCardName">Taxpayer name</label>
                  <input type="text" id="tcc_taxpayer_name"  class="form-control" name="tcc_taxpayer_name" placeholder="John Doe" />
                </div>
                <div class="col-12">
                    <label class="form-label" for="modalAddCardName">Taxpayer tin</label>
                    <input type="text"  id="tcc_taxpayer_tin"  class="form-control" name="tcc_taxpayer_tin" placeholder="John Doe" />
                  </div>
                <div class="col-6 col-md-3">
                  <label class="form-label" for="modalAddCardExpiryDate">Start year</label>
                  <input
                    oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                    type="text"
                    id="tcc_start_year"
                    name="tcc_start_year"
                    class="form-control"
                    placeholder="2020" />
                </div>
                
                <div class="col-12 text-center">
                  <button type="submit" class="btn btn-primary me-3">Submit</button>
                  <button
                    type="reset"
                    class="btn btn-label-secondary btn-reset"
                    data-bs-dismiss="modal"
                    aria-label="Close">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!--/ Add New Credit Card Modal -->


    <!-- Include Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.x/dist/js/bootstrap.bundle.min.js"></script>

    <script src="/assets/js/tables-datatables-basic.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="/assets/vendor/libs/bootstrap-select/bootstrap-select.js"></script>
    <script src="/assets/js/forms-selects.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- Main JS -->
    <script src="/assets/js/main.js"></script>

    <script>
        $(document).ready(function () {
            $("#userTable").DataTable({
                ordering: false,
                paging: true,
                pageLength: 10,
                searching: false,
            });
        });
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.offcanvas') && document.querySelector('.offcanvas.show')) {
                const offcanvas = bootstrap.Offcanvas.getInstance(document.querySelector('.offcanvas.show'));
                offcanvas.hide();
            }
        });
        document.addEventListener('hidden.bs.offcanvas', function () {
            const backdrops = document.querySelectorAll('.offcanvas-backdrop');
            backdrops.forEach((backdrop) => backdrop.remove());
        });

        $(document).ready(function () {
            $("#add-new-record").on("submit", function (e) {
                e.preventDefault();

                $("#loading-spinner").removeClass("d-none");

                const taxpayer_name = $("#taxpayer_name").val();
                const taxpayer_tin = $("#taxpayer_tin").val();
                const mobile_number = $("#mobile_number").val();
                const email_addresss = $("#email_addresss").val();
                const tax_payer_type = $("#tax_payer_type").val();
                const contactaddress = $("#contactaddress").val();
                const bvn = $("#bvn").val();
                const nin = $("#nin").val();


                const data = {
                    taxpayer_name,
                    taxpayer_tin,
                    mobile_number,
                    email_addresss,
                    tax_payer_type,
                    contactaddress,
                    bvn,
                    nin,
                };

                fetch("/tax/payers", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                })
                    .then((response) => {
                        $("#loading-spinner").addClass("d-none");
                        if (!response.ok) {
                            throw new Error("Failed to create record.");
                        }
                        return response.json();
                    })
                    .then((responseData) => {
                        toastr.success("Tax Payer created successfully!");

                        setTimeout(() => {
                            window.location.reload()

                        }, 2000)

                        $("#form-add-new-record")[0].reset();
                        const offcanvas = bootstrap.Offcanvas.getInstance($("#add-new-record")[0]);
                        offcanvas.hide();
                    })
                    .catch((error) => {
                        toastr.error(error.message || "An error occurred while creating the record.");
                    });
            });
        });


        document.addEventListener("DOMContentLoaded", () => {
            // Select buttons with both classes
            const allButtons = document.querySelectorAll("#generate_tcc, #delete_button");
            // Attach event listeners to all buttons
            allButtons.forEach(button => {
                button.addEventListener("click", handleButtonClick);
            });
        });

        function handleButtonClick(event) {
            event.preventDefault();
            const target = event.currentTarget;
            // Retrieve data attributes

            if (target.id === "generate_tcc") {
                const tin = target.getAttribute("data-tin"),
                name = target.getAttribute("data-name");
                openTCCModal({name, tin});
            }

            if(target.id === "delete_button") {
                const id = target.getAttribute("data-id");
                console.log({id})
                deleteRecord(id)
            }
        
        }

        // Function to edit taxpayer
        async function openTCCModal(taxpayer) {
            console.log(taxpayer)
            document.getElementById('tcc_taxpayer_name').value = taxpayer.name
            document.getElementById('tcc_taxpayer_tin').value = taxpayer.tin
            
            const editModal = new bootstrap.Modal(document.getElementById('addNewCCModal'));
            editModal.show();
            // Add logic here
        }

        const addNewCCForm = document.getElementById('addNewCCForm');
        addNewCCForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const data = new FormData(addNewCCForm);
            const payload = {
                tcc_taxpayer_name: data.get('tcc_taxpayer_name'),
                tcc_taxpayer_tin: data.get('tcc_taxpayer_tin'),
                tcc_start_year: data.get('tcc_start_year')
            }

            // console.log(payload)
            // return

            try {
                const request = await fetch('/tax/tcc', {
                    method: 'post',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                const response = await request.json();

                if(response.status == true) {
                    toastr.success(response.message);
                    setTimeout(() => {
                        location.reload()
                    }, 2000)
                } else {
                    toastr.error(response.message);
                }
            } catch (error) {
                toastr.error(response.message);
            }
        })

    </script>
</body>

</html>