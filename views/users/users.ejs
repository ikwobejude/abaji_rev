<!DOCTYPE html>
<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed layout-compact"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="/assets/"
  data-template="vertical-menu-template"
  data-style="light"
>
  <head>
    <%- include('../layout/head') %>
    <!-- Include Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.1/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->
        <%- include('../layout/aside') %>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          <%- include('../layout/side') %>
          <!-- / Navbar -->

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <!-- DataTable with Buttons -->
              <div class="card">
                <div class="card-header">
                  <div class="row">
                    <div class="col-6"></div>
                    <div class="col-6" style="text-align: end">
                      <button
                        class="create-new btn btn-primary waves-effect waves-light"
                      >
                        <i class="ti ti-plus me-sm-1"></i>
                        <span class="d-none d-sm-inline-block"
                          >Add New Record</span
                        >
                      </button>
                    </div>
                  </div>
                </div>

                <div class="card-datatable table-responsive pt-0">
                <table class="datatables-basic table">
                <thead>
                    <tr>
                    <th>#</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    </tr>
                </thead>
                <tbody>
                    <% 
                    const roleLookup = {};
                    user_role.forEach(role => {
                        roleLookup[role.group_id] = role.group_name;
                    });
                    %>
                    <% users.forEach((usr, index) => { %>
                    <tr>
                    <td><%= index + 1 %></td> 
                    <td><%= usr.name %></td> 
                    <td><%= usr.email %></td> 
                    <td><%= roleLookup[usr.group_id] || 'Unknown' %></td>
                    </tr>
                    <% }) %>
                </tbody>
                </table>

                </div>


              <!-- Modal to add new record -->
              <div class="offcanvas offcanvas-end" id="add-new-record">
                <div class="offcanvas-header border-bottom">
                  <h5 class="offcanvas-title" id="exampleModalLabel">
                    Add new user
                  </h5>
                  <button
                    type="button"
                    class="btn-close text-reset"
                    data-bs-dismiss="offcanvas"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="offcanvas-body flex-grow-1">
                  <form
                    class="add-new-record pt-0 row g-2"
                    id="form-upload-new-record"
                    onsubmit="return false"
                  >
                    <div class="col-12">
                      <label class="form-label" for="firstname"
                        >First Name</label
                      >
                      <input
                        type="text"
                        id="firstname"
                        name="firstname"
                        class="form-control"
                        placeholder="John"
                      />
                    </div>

                    <div class="col-12">
                      <label class="form-label" for="surname">Last Name</label>
                      <input
                        type="text"
                        id="surname"
                        name="surname"
                        class="form-control"
                        placeholder="Doe"
                      />
                    </div>

                    <div class="col-12">
                      <label class="form-label" for="middlename"
                        >Middle Name</label
                      >
                      <input
                        type="text"
                        id="middlename"
                        name="middlename"
                        class="form-control"
                        placeholder="Middle Name"
                      />
                    </div>

                    <div class="col-12">
                      <label class="form-label" for="user_phone">Phone</label>
                      <input
                        type="number"
                        id="user_phone"
                        name="user_phone"
                        class="form-control"
                        placeholder="Phone Number"
                      />
                    </div>

                    <div class="col-12">
                      <label class="form-label" for="email"
                        >Email Address</label
                      >
                      <input
                        type="email"
                        id="email"
                        name="email"
                        class="form-control"
                        placeholder="Email Address"
                      />
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label" for="password">Password</label>
                      <input
                        type="password"
                        id="password"
                        name="password"
                        class="form-control"
                        placeholder="Password"
                      />
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label" for="group_id">User Role</label>
                      <select
                        id="group_id"
                        name="group_id"
                        class="select2 form-select"
                        data-allow-clear="true"
                      >
                        <option value="">Select</option>
                        <% user_role.forEach((role) => { %>
                        <option value="<%= role.group_id %>">
                          <%= role.group_name %>
                        </option>
                        <% }) %>
                      </select>
                    </div>

                    <div class="col-sm-12">
                      <button
                        type="submit"
                        id="submit-btn"
                        class="btn btn-primary me-sm-4 me-1"
                      >
                        <span
                          class="spinner-border d-none"
                          id="loading-spinner"
                          role="status"
                          aria-hidden="true"
                        ></span>
                        &nbsp;Submit
                      </button>
                      <button
                        type="reset"
                        class="btn btn-outline-secondary"
                        data-bs-dismiss="offcanvas"
                      >
                        Cancel
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Toast Container -->
              <div class="toast-container position-fixed top-0 end-0 p-3">
                <div
                  id="toast"
                  class="toast"
                  role="alert"
                  aria-live="assertive"
                  aria-atomic="true"
                >
                  <div class="toast-header">
                    <strong class="me-auto">Notification</strong>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="toast"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="toast-body" id="toast-message">
                  </div>
                </div>
              </div>
            </div>
            <!-- / Content -->
            <%- include('../layout/footer') %>
          </div>
        </div>
      </div>
    </div>

    <!-- Include Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/tables-datatables-basic.js"></script>
   <script>
  document
    .getElementById("form-upload-new-record")
    .addEventListener("submit", async function (event) {
      event.preventDefault();

      // Get form data
      const formData = {
        firstname: document.getElementById("firstname").value,
        surname: document.getElementById("surname").value,
        middlename: document.getElementById("middlename").value,
        user_phone: document.getElementById("user_phone").value,
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
        group_id: document.getElementById("group_id").value,
      };

      const submitBtn = document.getElementById("submit-btn");
      const loadingSpinner = document.getElementById("loading-spinner");

      submitBtn.disabled = true;
      loadingSpinner.classList.remove("d-none");

      try {
        const response = await fetch("/admin/user", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        });

        const result = await response.json();
        if (response.ok) {
          toastr.success("User added successfully!");
          document.getElementById("form-upload-new-record").reset();
        } else {
          toastr.error(result.message || "Failed to add user.");
        }
      } catch (error) {
        toastr.error("An error occurred while processing your request.");
      } finally {
        loadingSpinner.classList.add("d-none");
        submitBtn.disabled = false;
      }
    });
</script>

    <script src="../../assets/vendor/libs/toastr/toastr.js"></script>

    <!-- Main JS -->
    <script src="../../assets/js/main.js"></script>

    <!-- Page JS -->
    <script src="../../assets/js/ui-toasts.js"></script>
  </body>
</html>
